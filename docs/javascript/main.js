import*as e from"../vendor/three/javascript/three.module.js";const t=class{static createBlobFromCanvas(e){return new Promise((function(t){e.toBlob(t)}))}static createColorFromValue(t){const i=t%256,s=Math.trunc((t-i)%65536/256),n=Math.trunc((t-256*s-i)%16777216/65536);return new e.Color("rgb("+i+", "+s+", "+n+")")}static createMaterialFromValue(i){const s=t.createColorFromValue(i);return new e.MeshBasicMaterial({color:s})}},i=e=>[Math.trunc(255*e.r),Math.trunc(255*e.g),Math.trunc(255*e.b)],s=class{constructor(e,t,i,s,n,o){this.kitId=e,this.pieceIndexInKit=t,this.positionX=i,this.positionY=s,this.positionZ=n,this.rotationZ=o}},n=class{constructor(e,t,i,s,n,o){this.name=e,this.eyeRadius=t,this.eyeAngle=i,this.consAngle=s,this.consMoveX=n,this.consMoveY=o}cloneView(){return new n(this.name,this.eyeRadius,this.eyeAngle,this.consAngle,this.consMoveX,this.consMoveY)}static createDefaultView(e){return new n("Default",2*Math.trunc(1.45*Math.max(e.constructionWidth,e.constructionHeight)/2+1),65,0,0,0)}},o=["o001-kS84YMny","o002-qHc53ynS","o003-kC83Y5f2","o004-a6QVnB6D"],c=Math.PI,a=c/4,r=c/180,l=e=>e*r,h=(t,i,s)=>new e.Color("rgb("+t+", "+i+", "+s+")"),p=new e.Matrix4;p.set(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1);const d=e=>{e.applyMatrix4(p)},u=new e.Color(0),m=e=>{const t=$(document),i=$("#color-picker-saturation-lightness-box"),s=$("#saturation-linear-gradient"),n=$("#color-picker-saturation-lightness-box-thumb"),o=$("#color-picker-preview"),c=$("#color-picker-hue-slider"),a=$("#color-picker-hue-slider-thumb"),r=$("#color-picker-hex"),l=$("#color-picker-red"),h=$("#color-picker-green"),p=$("#color-picker-blue");e.type="",e.r=0,e.g=0,e.b=0,e.h=0,e.s=0,e.v=0,e.fromRgbToHexString=()=>{const t=(65536*Math.round(255*e.r)+256*Math.round(255*e.g)+Math.round(255*e.b)).toString(16);return"00000".substr(0,6-t.length)+t},e.fromHexStringToRgb=t=>{const i=t.match(/^#?([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])$/i);i&&(e.r=parseInt(i[1],16)/255,e.g=parseInt(i[2],16)/255,e.b=parseInt(i[3],16)/255)},e.fromHsvToRgb=()=>{const t=e.h,i=e.s,s=e.v,n=Math.min(5,Math.floor(6*t)),o=6*t-n,c=s*(1-i),a=s*(1-o*i),r=s*(1-(1-o)*i);switch(n){case 0:e.r=s,e.g=r,e.b=c;break;case 1:e.r=a,e.g=s,e.b=c;break;case 2:e.r=c,e.g=s,e.b=r;break;case 3:e.r=c,e.g=a,e.b=s;break;case 4:e.r=r,e.g=c,e.b=s;break;case 5:e.r=s,e.g=c,e.b=a}},e.fromRgbToHsv=()=>{const t=e.r,i=e.g,s=e.b,n=Math.max(t,i,s),o=n-Math.min(t,i,s);if(e.s=0===n?0:o/n,e.v=n,0===o)e.h=0;else switch(n){case t:e.h=(i-s)/o/6+(i<s?1:0);break;case i:e.h=(s-t)/o/6+1/3;break;case s:e.h=(t-i)/o/6+2/3}},e.saturationLightnessBoxStatus=!1,e.hueSliderStatus=!1,e.updateRgbInputs=()=>{l.val(Math.round(255*e.r)),h.val(Math.round(255*e.g)),p.val(Math.round(255*e.b))},e.updateHexInput=()=>{r.val(e.fromRgbToHexString)},e.updatePreview=()=>{o[0].children[0].setAttribute("fill","rgb("+255*e.r+", "+255*e.g+", "+255*e.b+")")},e.updateSaturationLightnessBoxHue=()=>{s[0].children[1].setAttribute("stop-color","hsl("+359*e.h+", 100%, 50%)")},e.updateSaturationLightnessThumb=()=>{const t=i.width()-1,s=i.height()-1;n.css("left",t*e.s+11),n.css("top",s*(1-e.v)+72)},e.updateHueSlider=()=>{a.css("left",c.width()*e.h+6),a.css("top",16)},e.setColor=t=>{e.type=t.type,e.r=t.r,e.g=t.g,e.b=t.b,e.fromRgbToHsv(),e.updatePreview(),e.updateSaturationLightnessBoxHue(),e.updateSaturationLightnessThumb(),e.updateHueSlider(),e.updateHexInput(),e.updateRgbInputs()},e.getColor=()=>({type:e.type,r:e.r,g:e.g,b:e.b}),e.saturationLightnessBoxHandler=(t,s)=>{const o=i.width()-1,c=i.height()-1;let a=t-i.position().left,r=s-i.position().top;a<0&&(a=0),a>o&&(a=o),r<0&&(r=0),r>c&&(r=c),n.css("left",a+11),n.css("top",r+72),e.s=a/o,e.v=1-r/c,e.fromHsvToRgb(),e.updatePreview(),e.updateHexInput(),e.updateRgbInputs()},e.hueSliderHandler=t=>{const i=c.width()-1;let s=t-c.position().left;s<0&&(s=0),s>i&&(s=i),a.css("left",s+6),a.css("top",16),e.h=s/i,e.fromHsvToRgb(),e.updatePreview(),e.updateSaturationLightnessBoxHue(),e.updateHexInput(),e.updateRgbInputs()},e.hexInputHandler=()=>{const t=r.val();e.r=parseInt(t.substr(0,2),16)/255,e.g=parseInt(t.substr(2,2),16)/255,e.b=parseInt(t.substr(4,2),16)/255,e.fromRgbToHsv(),e.updatePreview(),e.updateSaturationLightnessBoxHue(),e.updateSaturationLightnessThumb(),e.updateHueSlider(),e.updateRgbInputs()},e.rgbInputHandler=()=>{e.r=parseInt(""+l.val())/255,e.g=parseInt(""+h.val())/255,e.b=parseInt(""+p.val())/255,e.fromRgbToHsv(),e.updatePreview(),e.updateSaturationLightnessBoxHue(),e.updateSaturationLightnessThumb(),e.updateHueSlider(),e.updateHexInput()},i.on("mousedown",(t=>{e.saturationLightnessBoxStatus=!0,e.saturationLightnessBoxHandler(t.pageX,t.pageY)})),n.on("mousedown",(()=>{i.trigger("mousedown")})),t.on("mousemove",(t=>{!0===e.saturationLightnessBoxStatus&&e.saturationLightnessBoxHandler(t.pageX,t.pageY)})),t.on("mouseup",(()=>{!0===e.saturationLightnessBoxStatus&&(e.saturationLightnessBoxStatus=!1)})),c.on("mousedown",(t=>{e.hueSliderStatus=!0,e.hueSliderHandler(t.pageX)})),a.on("mousedown",(()=>{c.trigger("mousedown")})),t.on("mousemove",(t=>{!0===e.hueSliderStatus&&e.hueSliderHandler(t.pageX)})),t.on("mouseup",(()=>{!0===e.hueSliderStatus&&(e.hueSliderStatus=!1)})),r.on("paste keyup",(()=>{e.hexInputHandler()})),l.on("paste keyup",(()=>{e.rgbInputHandler()})),h.on("paste keyup",(()=>{e.rgbInputHandler()})),p.on("paste keyup",(()=>{e.rgbInputHandler()}))},g=["Distribution 1000 Pieces","Distribution Blue Mountain","Distribution Left Tower","Distribution Red Mountain"],w=Math.PI,v=e=>{let i=!1,s=!1,n=0,o=0,c=0,a=0;const r=w/3,l=$("#site-canvas"),h=$(window);let p=-1,d=0;const u=()=>{if(i&&p>-1){if(0!==d){let t=e.app.site.currentView.consAngle+d;t>=360?t=360-t:t<0&&(t=360+t),e.app.site.currentView.consAngle=t,e.updateViewNameLabel(),e.app.site.renderConstruction(),e.app.site.renderPiece(),e.app.site.renderPieceBase()}setTimeout((()=>{u()}),p)}};let m=-1,g=0;const v=()=>{i&&m>-1&&(0!==g&&(e.app.site.currentView.eyeAngle+=g,e.app.site.currentView.eyeAngle=e.app.site.currentView.eyeAngle>90?90:e.app.site.currentView.eyeAngle,e.app.site.currentView.eyeAngle=e.app.site.currentView.eyeAngle<0?0:e.app.site.currentView.eyeAngle,e.updateViewNameLabel(),e.app.site.renderConstruction(),e.app.site.renderPiece(),e.app.site.renderPieceBase()),setTimeout((()=>{v()}),m))};l.on("mousedown",(t=>{i=!0,s=!1,n=t.clientX,o=t.clientY,c=e.app.site.currentView.consMoveX,a=e.app.site.currentView.consMoveY,t.clientX,t.clientY,p=-1,m=-1})),l.on("mousemove",(t=>{if(!i)return;const l=t.clientX-n,h=t.clientY-o;0===l&&0===h||(s=!0,t.clientX,t.clientY,((t,i,s)=>{const n=-Math.atan2(s,i),o=n+(n<0?2*w:0);if(t)o>r&&o<2*r||o>4*r&&o<5*r?(p=-1,-1===m&&(m=1,v()),m=s,m<0?(g=2,m*=-1):g=-2,m*=2,m=m>250?250:m,m=250-m):(m=-1,-1===p&&(p=1,u()),p=i,p>0?d=2:(d=-2,p*=-1),p*=2,p=p>250?250:p,p=250-p);else{let t=!1;const n=e.app.site.canvas.height/e.app.site.currentView.eyeRadius,o=Math.trunc(i/n);e.app.site.currentView.consMoveX!==c+o&&(e.app.site.currentView.consMoveX=c+o,t=!0);const r=Math.trunc(s/n);e.app.site.currentView.consMoveY!==a+r&&(e.app.site.currentView.consMoveY=a+r,t=!0),t&&(e.updateViewNameLabel(),e.app.site.renderConstruction())}})(t.ctrlKey,l,h))})),h.on("mouseup",(()=>{i=!1})),l.on("click",(t=>{s?s=!1:((t,i,s)=>{if(e.hideErrorMessage(),t){const t=e.app.site.extractPiece(i,s);"OK"===t?e.app.site.renderConstruction():e.showErrorMessage("Extract piece exception",t)}else{const t=e.app.site.insertCurrentPiece(i,s);"OK"===t?e.app.site.renderConstruction():e.showErrorMessage("Insert piece exception",t)}})(t.shiftKey,t.clientX,t.clientY)})),document.querySelector("#site-canvas").addEventListener("wheel",(t=>{const i=t.deltaY,s=2*Math.abs(Math.trunc(Math.abs(i)/(e.app.site.canvas.clientHeight/12)));t.shiftKey?i<0?e.app.site.currentView.consMoveY-=s:e.app.site.currentView.consMoveY+=s:i<0?e.app.site.currentView.eyeRadius-=s:e.app.site.currentView.eyeRadius+=s,e.updateViewNameLabel(),e.app.site.renderConstruction()}),{passive:!0});const b=$("#construction-button");return b.dropdown({onShow:()=>{b.dropdown("clear")}}),$("#construction-menu-close").on("click",(()=>{(async()=>{e.$startDimmer.addClass("active"),e.$startModal.modal("show")})()})),$("#construction-menu-screenshot").on("click",(async()=>{e.app.site.renderConstruction();const i=await t.createBlobFromCanvas(e.app.site.canvas);e.downloadLink.setAttribute("download","pieces-construction-screenshot.png"),e.downloadLink.setAttribute("href",URL.createObjectURL(i)),e.downloadLink.click()})),$("#construction-menu-download").on("click",(async()=>{const t=e.app.site.construction.constructionToString();e.downloadLink.setAttribute("download",e.app.site.construction.name+".p3c"),e.downloadLink.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),e.downloadLink.click()})),$("#construction-name")},b=e=>{const t=$("#construction-info-modal");t.modal({centered:!1}).modal("setting","closable",!1).modal("setting","dimmerSettings",{opacity:0}).modal("setting","onApprove",(()=>!1));const i=$("#info-modal-name-input"),s=$("#info-modal-error-message");$("#construction-menu-info").on("click",(()=>{$("tr[id^='kit-pieces-table-row-item']").remove();const s=$("#kit-pieces-footer-table-row"),n=$("#kit-pieces-table-row-template"),o=e.app.site.construction;let c=0;for(const e of o.kits){const e=n.clone();e.attr("id","kit-pieces-table-row-item-"+c++),e.show(),e.insertBefore(s)}i.val(o.name);const a=t.find(".table p");let r=1;a.eq(r++).text(o.constructionWidth),a.eq(r++).text(o.constructionHeight),a.eq(r++).text(o.constructionDepth),a.eq(r++).text(o.kits.length);const l=e.app.site.construction.findPiecesPerKit();let h=0;for(const e of l.values())e>0&&h++;a.eq(r++).text(h),r++,r++;for(const t of o.kits)a.eq(r++).text(e.app.site.availableKitInfos.get(t).name),a.eq(r++).text(l.get(t));a.eq(r++).text(o.pieces.length),t.modal("show")}));$("#construction-info-modal .approve").on("click",(async()=>{i.parent().parent().parent().removeClass("error");const n=((e,t)=>{const i=e.val().trim();return e.parent().removeClass("error"),0===i.length?(e.parent().addClass("error"),e.parent().parent().parent().addClass("error"),e.trigger("focus"),s.html("Construction "+t+" cannot be empty"),""):i})(i,"name");0!==n.length&&(e.app.site.construction.name!==n&&(e.app.site.construction.name=n,e.$constructionName.html(n)),t.modal("hide"))})),$("#construction-info-modal .cancel").on("click",(async()=>{t.modal("hide")}))},k=Math.PI/4,f=Math.PI/16;(async()=>{const r=new class{constructor(){this.site=new class{constructor(){const t=document.querySelector("#site-canvas"),s=document.querySelector("#piece-canvas"),n=document.querySelector("#piece-base-canvas"),o=document.querySelector("#piece-image-canvas"),a=document.querySelector("#view-image-canvas");this.construction=new class{constructor(){this.kits=[],this.views=[],this.pieces=[]}findPiecesPerKit(){const e=new Map;for(const t of this.kits)e.set(t,0);for(const t of this.pieces){const i=t.kitId;e.set(i,e.get(i)+1)}return e}constructionToString(){const e={};e.name=this.name,e.sceneColor=i(this.sceneColor),e.baseColor=i(this.baseColor),e.constructionWidth=this.constructionWidth,e.constructionHeight=this.constructionHeight,e.constructionDepth=this.constructionDepth,e.view_Name=[],e.view_EyeRadius=[],e.view_EyeAngle=[],e.view_ConsAngle=[],e.view_ConsMoveX=[],e.view_ConsMoveY=[];for(const t of this.views)e.view_Name.push(t.name),e.view_EyeRadius.push(t.eyeRadius),e.view_EyeAngle.push(t.eyeAngle),e.view_ConsAngle.push(t.consAngle),e.view_ConsMoveX.push(t.consMoveX),e.view_ConsMoveY.push(t.consMoveY);e.pieces_kitId=[],e.pieces_IndexInKit=[],e.pieces_positionX=[],e.pieces_positionY=[],e.pieces_positionZ=[],e.pieces_rotationZ=[];const t=new Map;let s=0;for(const i of this.pieces){const n=i.kitId;t.has(n)||(t.set(n,s),s++),e.pieces_kitId.push(t.get(n)),e.pieces_IndexInKit.push(i.pieceIndexInKit),e.pieces_positionX.push(i.positionX),e.pieces_positionY.push(i.positionY),e.pieces_positionZ.push(i.positionZ),e.pieces_rotationZ.push(i.rotationZ)}e.kits=[];for(const i of t.keys())e.kits.push(i);return console.log(e),JSON.stringify(e,null,4)}},this.volume=[[[]]],this.canvas=t,this.renderer=new e.WebGLRenderer({canvas:t,antialias:!0}),this.scene=new e.Scene,d(this.scene);const r=new e.AmbientLight(16777215,1);this.scene.add(r),this.afterLightsSceneIndex=1,this.camera=new e.PerspectiveCamera(45,1,3,500),this.pickingRenderTarget=new e.WebGLRenderTarget(1,1),this.pickingScene=new e.Scene,d(this.pickingScene),this.pickingScene.background=u,this.pieceCanvas=s,this.pieceRenderer=new e.WebGLRenderer({canvas:s,antialias:!0}),this.pieceRenderer.setSize(s.clientWidth,s.clientHeight,!1),this.pieceScene=new e.Scene,d(this.pieceScene),this.pieceSceneObjectIndex=-1;const h=new e.AmbientLight(16777215,1);this.pieceScene.add(h),this.pieceCamera=new e.PerspectiveCamera(45,1,3,50),this.pieceBaseCanvas=n,this.pieceBaseRenderer=new e.WebGLRenderer({canvas:n,antialias:!0}),this.pieceBaseRenderer.setSize(n.clientWidth,n.clientHeight,!1),this.pieceBaseScene=new e.Scene,d(this.pieceBaseScene),this.pieceBaseSceneObjectIndex=-1;const p=new e.AmbientLight(16777215,1);this.pieceBaseScene.add(p),this.pieceBaseCamera=new e.PerspectiveCamera(45,1,3,50),this.pieceBasePickingRenderTarget=new e.WebGLRenderTarget(n.clientWidth,n.clientHeight),this.pieceBasePickingScene=new e.Scene,d(this.pieceBasePickingScene),this.pieceBasePickingSceneObjectIndex=-1,this.pieceBasePickingScene.background=u,this.pieceImageCanvas=o,this.pieceImageRenderer=new e.WebGLRenderer({canvas:this.pieceImageCanvas,antialias:!0}),this.pieceImageRenderer.setSize(this.pieceImageCanvas.clientWidth,this.pieceImageCanvas.clientHeight,!1),this.pieceImageScene=new e.Scene,d(this.pieceImageScene),this.pieceImageSceneObjectIndex=-1;const m=new e.AmbientLight(16777215,1);this.pieceImageScene.add(m),this.pieceImageCamera=new e.PerspectiveCamera(45,1,3,50),this.viewImageCanvas=a,this.viewImageRenderer=new e.WebGLRenderer({canvas:this.viewImageCanvas,antialias:!0}),this.viewImageRenderer.setSize(this.viewImageCanvas.clientWidth,this.viewImageCanvas.clientHeight,!1),this.resize=(e=!1)=>{const t=this.renderer.domElement,i=window.devicePixelRatio,s=t.clientWidth*i|0,n=t.clientHeight*i|0;if(t.width!==s||t.height!==n||e){this.renderer.setSize(s,n,!1),this.pickingRenderTarget.setSize(s,n);const e=t.clientWidth/t.clientHeight;this.camera.aspect=t.clientWidth/t.clientHeight,this.camera.updateProjectionMatrix(),this.viewImageWidth=Math.trunc(160*e)}},this.resetScene=e=>{e.position.x=0,e.position.y=0,e.position.z=0,e.rotation.x=-0,e.rotation.y=0,e.rotation.z=-c},this.transformSceneByView=(e,t)=>{this.resetScene(e),e.translateZ(-1*t.eyeRadius),e.rotateX(l(t.eyeAngle)),e.translateX(-1*t.consMoveX),e.translateY(t.consMoveY),e.rotateZ(l(t.consAngle)),e.translateX(this.construction.constructionWidth/2),e.translateY(this.construction.constructionHeight/2*-1)},this.insertPieceReturn={m00:"OK",m01:"Clicked on background, please click on the base or on the top of a piece",m02:"Clicked on piece lateral side, please click on the base or on the top of a piece",m03:"Out of construction bounds",m04:"Some of the piece volume is already occupied"},this.extractPieceReturn={m00:"OK",m01:"Clicked on the background, please click on a piece",m02:"Clicked on the base, please click on a piece",m03:"The piece top is not completely free"},this.availableKitInfos=new Map,this.loadedKits=new Map,this.kitPieceImageUrls=new Map}renderConstruction(){this.transformSceneByView(this.scene,this.currentView),this.renderer.render(this.scene,this.camera)}renderConstructionPicking(e,t){this.transformSceneByView(this.pickingScene,this.currentView),this.renderer.setRenderTarget(this.pickingRenderTarget),this.renderer.render(this.pickingScene,this.camera);const i=new Uint8Array(4);return this.renderer.readRenderTargetPixels(this.pickingRenderTarget,e,this.canvas.height-(t+1),1,1,i),this.renderer.setRenderTarget(null),i[2]<<16|i[1]<<8|i[0]}renderPiece(){this.resetScene(this.pieceScene),this.pieceScene.translateZ(-13),this.pieceScene.rotateX(l(this.currentView.eyeAngle)),this.pieceScene.rotateZ(l(this.currentView.consAngle)),this.pieceRenderer.render(this.pieceScene,this.pieceCamera)}renderPieceBase(){this.resetScene(this.pieceBaseScene),this.pieceBaseScene.translateZ(-12),this.pieceBaseScene.rotateZ(l(this.currentView.consAngle)),this.pieceBaseRenderer.render(this.pieceBaseScene,this.pieceBaseCamera)}renderPieceBasePicking(e,t){this.resetScene(this.pieceBasePickingScene),this.pieceBasePickingScene.translateZ(-12),this.pieceBasePickingScene.rotateZ(l(this.currentView.consAngle)),this.pieceBaseRenderer.setRenderTarget(this.pieceBasePickingRenderTarget),this.pieceBaseRenderer.render(this.pieceBasePickingScene,this.pieceBaseCamera);const i=new Uint8Array(4);return this.pieceBaseRenderer.readRenderTargetPixels(this.pieceBasePickingRenderTarget,e,this.pieceBaseCanvas.clientHeight-(t+1),1,1,i),this.pieceBaseRenderer.setRenderTarget(null),i[2]<<16|i[1]<<8|i[0]}async renderPieceImage(e,i,s=a){this.createImagePiece(e,i),this.resetScene(this.pieceImageScene),this.pieceImageScene.translateZ(-13),this.pieceImageScene.rotateX(c/32*12),this.pieceImageScene.rotateZ(s),this.pieceImageRenderer.render(this.pieceImageScene,this.pieceImageCamera);const n=await t.createBlobFromCanvas(this.pieceImageCanvas);return URL.createObjectURL(n)}async renderViewImage(e,i){this.transformSceneByView(e,this.construction.views[i]),this.viewImageRenderer.render(e,this.camera);const s=await t.createBlobFromCanvas(this.viewImageCanvas);return URL.createObjectURL(s)}createCurrentPiece(){const e=this.loadedKits.get(this.currentKit).kitPieces[this.currentPieceIndexInKit];this.currentPiece=new s(this.currentKit,this.currentPieceIndexInKit,1===this.currentPieceRotation||3===this.currentPieceRotation?-.5*e.width:-.5*e.height,1===this.currentPieceRotation||3===this.currentPieceRotation?-.5*e.height:-.5*e.width,-.5*e.depth,this.currentPieceRotation),this.pieceSceneObjectIndex>-1&&this.pieceScene.children.splice(this.pieceSceneObjectIndex,1);const t=e.createSceneObject(this.currentPiece);this.pieceScene.add(t),this.pieceSceneObjectIndex=this.pieceScene.children.length-1,this.pieceBasePickingSceneObjectIndex>-1&&this.pieceBasePickingScene.children.splice(this.pieceBasePickingSceneObjectIndex,1);const i=e.createPickingBaseSceneObject(this.currentPiece);this.pieceBasePickingScene.add(i),this.pieceBasePickingSceneObjectIndex=this.pieceBasePickingScene.children.length-1}createCurrentPieceBase(){this.pieceBaseSceneObjectIndex>-1&&this.pieceBaseScene.children.splice(this.pieceBaseSceneObjectIndex,1);const e=this.loadedKits.get(this.currentKit).kitPieces[this.currentPieceIndexInKit].createBaseSceneObject(this.currentPiece,this.currentPiecePoint);this.pieceBaseScene.add(e),this.pieceBaseSceneObjectIndex=this.pieceBaseScene.children.length-1}createImagePiece(e,t){const i=this.loadedKits.get(e).kitPieces[t],n=new s("",-1,-.5*i.width,-.5*i.height,-.5*i.depth,0);this.pieceImageSceneObjectIndex>-1&&this.pieceImageScene.children.splice(this.pieceImageSceneObjectIndex,1);const o=i.createSceneObject(n);this.pieceImageScene.add(o),this.pieceImageSceneObjectIndex=this.pieceImageScene.children.length-1}getVolume(e,t,i){return void 0===this.volume[e]||void 0===this.volume[e][t]||void 0===this.volume[e][t][i]?0:this.volume[e][t][i]}setVolume(e,t,i,s){void 0===this.volume[e]&&(this.volume[e]=[]),void 0===this.volume[e][t]&&(this.volume[e][t]=[]),this.volume[e][t][i]=s}addPiece(e,t,i,n,o,c){const a=new s(e,t,i,n,o,c),r=this.construction.pieces.push(a),l=this.loadedKits.get(e).kitPieces[t],h=l.createSceneObject(a);this.scene.add(h);const p=l.createPickingSceneObject(a,r,l.width,l.height,l.depth);this.pickingScene.add(p);let d=0,u=0;for(let e=0;e<l.width;e++)for(let t=0;t<l.height;t++)for(let s=0;s<l.depth;s++)if(1===l.getVolume(e,t,s)){switch(a.rotationZ){case 1:d=e,u=t;break;case 2:d=t,u=l.width-e-1;break;case 3:d=l.width-e-1,u=l.height-t-1;break;case 4:d=l.height-t-1,u=e}this.setVolume(i+d,n+u,o+s,r)}}insertCurrentPiece(e,t){const i=this.renderConstructionPicking(e,t);if(0===i)return this.insertPieceReturn.m01;let s=0,n=0,o=0;if(i>1e7){const e=i-10000001,t=this.construction.constructionWidth;s=e%t,n=Math.trunc(e/t)}else{const e=Math.trunc(i/101)-1,t=i%101;if(0===t)return this.insertPieceReturn.m02;const c=this.construction.pieces[e],a=this.loadedKits.get(c.kitId).kitPieces[c.pieceIndexInKit];s=c.positionX,n=c.positionY,o=c.positionZ;const r=(t-1)%a.height,l=Math.trunc((t-1)/a.height);switch(o+=a.depth,c.rotationZ){case 1:s+=l,n+=r;break;case 2:s+=r,n=n+(a.width-l)-1;break;case 3:s=s+(a.width-l)-1,n=n+(a.height-r)-1;break;case 4:s=s+(a.height-r)-1,n+=l}}let c=0,a=0,r=o;const l=this.currentPiece,h=this.loadedKits.get(l.kitId).kitPieces[l.pieceIndexInKit],p=(this.currentPiecePoint-1)%h.height,d=Math.trunc((this.currentPiecePoint-1)/h.height);switch(l.rotationZ){case 1:c=s-d,a=n-p;break;case 2:c=s-p,a=n-(h.width-d)+1;break;case 3:c=s-(h.width-d)+1,a=n-(h.height-p)+1;break;case 4:c=s-(h.height-p)+1,a=n-d}switch(l.rotationZ){case 1:if(c+h.width>this.construction.constructionWidth||a+h.height>this.construction.constructionHeight||r+h.depth>this.construction.constructionDepth||c<0||a<0||r<0)return this.insertPieceReturn.m03;break;case 2:if(c+h.height>this.construction.constructionWidth||a+h.width>this.construction.constructionHeight||r+h.depth>this.construction.constructionDepth||c<0||a<0||r<0)return this.insertPieceReturn.m03;break;case 3:if(c+h.width>this.construction.constructionWidth||a+h.height>this.construction.constructionHeight||r+h.depth>this.construction.constructionDepth||c<0||a<0||r<0)return this.insertPieceReturn.m03;break;case 4:if(c+h.height>this.construction.constructionWidth||a+h.width>this.construction.constructionHeight||r+h.depth>this.construction.constructionDepth||c<0||a<0||r<0)return this.insertPieceReturn.m03}let u=0,m=0;for(let e=0;e<h.width;e++)for(let t=0;t<h.height;t++)for(let i=0;i<h.depth;i++)if(1===h.getVolume(e,t,i)){switch(l.rotationZ){case 1:u=e,m=t;break;case 2:u=t,m=h.width-e-1;break;case 3:u=h.width-e-1,m=h.height-t-1;break;case 4:u=h.height-t-1,m=e}if(0!==this.getVolume(c+u,a+m,r+i))return this.insertPieceReturn.m04}return this.addPiece(l.kitId,l.pieceIndexInKit,c,a,r,l.rotationZ),this.insertPieceReturn.m00}extractPiece(e,t){const i=this.renderConstructionPicking(e,t);if(0===i)return this.extractPieceReturn.m01;if(i>1e7)return this.extractPieceReturn.m02;const s=Math.trunc(i/101),n=s-1,o=this.construction.pieces[n],c=o.positionX,a=o.positionY,r=this.loadedKits.get(o.kitId).kitPieces[o.pieceIndexInKit],l=r.width,h=r.height,p=o.positionZ+r.depth;if(p!==this.construction.constructionDepth)for(let e=0;e<l;e++)for(let t=0;t<h;t++)switch(o.rotationZ){case 1:if(0!==this.getVolume(c+e,a+t,p))return this.extractPieceReturn.m03;break;case 2:if(0!==this.getVolume(c+t,a+(l-e-1),p))return this.extractPieceReturn.m03;break;case 3:if(0!==this.getVolume(c+(l-e-1),a+(h-t-1),p))return this.extractPieceReturn.m03;break;case 4:if(0!==this.getVolume(c+(h-t-1),a+e,p))return this.extractPieceReturn.m03}for(let e=0;e<this.construction.constructionWidth;e++)for(let t=0;t<this.construction.constructionHeight;t++)for(let i=0;i<this.construction.constructionDepth;i++){const n=this.getVolume(e,t,i);n>=s&&(n>s?this.setVolume(e,t,i,n-1):this.setVolume(e,t,i,0))}this.scene.children.splice(this.pieceSceneObjectsStartIndex+n,1),this.pickingScene.children.splice(this.piecePickingSceneObjectsStartIndex+n,1),this.construction.pieces.splice(n,1);for(let e=this.piecePickingSceneObjectsStartIndex+n,t=this.pickingScene.children.length;e<t;e++){const t=this.pickingScene.children[e],i=t.pieceIndexPlusOne;i>=n+1&&t.changePieceIndex(i-1)}return this.extractPieceReturn.m00}addBaseObjectToScene(){const i=this.construction.constructionWidth,s=this.construction.constructionHeight,n=new e.PlaneBufferGeometry(i,s),o=new e.MeshPhongMaterial({color:this.construction.baseColor}),c=new e.Mesh(n,o);this.scene.add(c),this.baseSceneIndex=this.scene.children.length-1,c.position.x=i/2,c.position.y=s/2;const a=new e.PlaneBufferGeometry(1,1);for(let n=0;n<i;n++)for(let o=0;o<s;o++){const s=1e7+n+i*o+1,c=t.createMaterialFromValue(s),r=new e.Mesh(a,c);this.pickingScene.add(r),r.position.x=.5+n,r.position.y=.5+o}this.pieceSceneObjectsStartIndex=this.scene.children.length,this.piecePickingSceneObjectsStartIndex=this.pickingScene.children.length}async loadAvailableKitInfos(){this.availableKitInfos.clear();for(const e of o){const t=await $.get("kits/kit-"+e+"/info.json"),i=t.id;this.availableKitInfos.set(i,t)}}async loadKits(){this.loadedKits.clear();for(const e of this.construction.kits){const t=this.availableKitInfos.get(e),i=await import("../kits/kit-"+t.prefix+t.increment+"-"+t.id+"/javascript/kit.js"),s=await i.loadKit();this.loadedKits.set(e,s)}}reset(){const e=this.construction;this.scene.background=e.sceneColor,this.pieceScene.background=e.sceneColor,this.pieceImageScene.background=e.sceneColor,this.pieceBaseScene.background=e.baseColor,this.currentKit=e.kits[0],this.currentView=e.views[0].cloneView(),this.currentPieceIndexInKit=0,this.currentPieceRotation=1,this.currentPiecePoint=1,this.kitPieceImageUrls.clear()}async loadNew(e,t,i,s,o){const c=this.construction;c.name=e,c.constructionWidth=t,c.constructionHeight=i,c.constructionDepth=s,c.sceneColor=h(158,195,232),c.baseColor=h(0,128,0),c.kits.splice(0),c.views.splice(0),c.pieces.splice(0),this.scene.children.splice(this.afterLightsSceneIndex),this.pickingScene.children.splice(0),this.addBaseObjectToScene(),c.kits=o,await this.loadKits(),c.views.push(n.createDefaultView(c)),this.reset()}async loadFromString(e){const t=JSON.parse(e),i=this.construction;i.name=t.name,i.kits.splice(0),i.views.splice(0),i.pieces.splice(0),this.scene.children.splice(this.afterLightsSceneIndex),this.pickingScene.children.splice(0),this.volume=[[[]]],i.sceneColor=h(t.sceneColor[0],t.sceneColor[1],t.sceneColor[2]),i.baseColor=h(t.baseColor[0],t.baseColor[1],t.baseColor[2]),i.constructionWidth=t.constructionWidth,i.constructionHeight=t.constructionHeight,i.constructionDepth=t.constructionDepth;for(let e=0;e<t.view_Name.length;e++){const s=new n(t.view_Name[e],t.view_EyeRadius[e],t.view_EyeAngle[e],t.view_ConsAngle[e],t.view_ConsMoveX[e],t.view_ConsMoveY[e]);i.views.push(s)}const s=new Map;for(let e=0;e<t.kits.length;e++){const n=t.kits[e];i.kits.push(n),s.set(e,n)}this.loadedKits=new Map;for(const e of i.kits){const t=this.availableKitInfos.get(e),i=await import("../kits/kit-"+t.prefix+t.increment+"-"+t.id+"/javascript/kit.js"),s=await i.loadKit();this.loadedKits.set(e,s)}this.addBaseObjectToScene();for(let e=0;e<t.pieces_kitId.length;e++)this.addPiece(s.get(t.pieces_kitId[e]),t.pieces_IndexInKit[e],t.pieces_positionX[e],t.pieces_positionY[e],t.pieces_positionZ[e],t.pieces_rotationZ[e]);return this.reset(),"OK"}initialRenders(){this.resize(!0),this.renderConstruction(),this.renderPiece(),this.renderPieceBase()}},this.appUI=new class{constructor(e){this.app=e}showLandingPanel(){window.name="landing-page",this.startLandingCube(),this.$landingPanel.css("display","flex"),this.$startDimmer.removeClass("active")}showGalleryPanel(){window.name="landing-page",this.stopLandingCube(),this.$galleryPanel.css("display","flex"),this.$startDimmer.removeClass("active")}showStartModal(){window.name="start-modal",this.stopLandingCube(),this.$startModal.modal("show")}resetUI(){const e=this.app.site.construction;this.$constructionName.html(e.name),this.$constructionMenuSceneColorIcon.css("background-color","#"+e.sceneColor.getHexString()),this.$constructionMenuBaseColorIcon.css("background-color","#"+e.baseColor.getHexString()),this.$kitName.html(this.app.site.loadedKits.get(this.app.site.currentKit).kitInfo.name),this.createChooseViewItems(),this.updateViewNameLabel(),this.createChooseKitPieceItems(),this.createChooseKitPieceImages(),this.app.site.createCurrentPiece(),this.app.site.createCurrentPieceBase()}async loadUI(){this.$startDimmer=$("#start-dimmer"),this.$startDimmerContent=$("#start-dimmer-content"),this.$startModal=$("#start-modal"),$(window).on("resize",(async()=>{this.$startDimmer.hasClass("active")||"none"===this.$galleryPanel.css("display")&&"none"===this.$landingPanel.css("display")&&(this.app.site.resize(),this.app.site.renderConstruction())})),await this.app.site.loadAvailableKitInfos();const e=(e=>{const t=$("#landing-panel"),i=$("#cube-shape"),s=["flip up","flip down","flip right","flip left","flip over","flip back"],n=[$("#img-cube-1"),$("#img-cube-2"),$("#img-cube-3"),$("#img-cube-4"),$("#img-cube-5"),$("#img-cube-6")];i.shape();let o,c=1;return n[0].attr("src","assets/images/cube/"+Math.floor(16*Math.random())+".png"),$("#landing-panel-start-button").on("click",(()=>{e.$startDimmer.addClass("active"),e.$landingPanel.css("display","none"),e.showStartModal()})),$("#landing-panel-gallery-button").on("click",(()=>{e.showGalleryPanel(),e.$landingPanel.css("display","none")})),{startLandingCube:()=>{o=setInterval((async()=>{n[c].attr("src","assets/images/cube/"+Math.floor(16*Math.random())+".png"),c=5===c?0:c+1,i.shape(s[Math.floor(6*Math.random())])}),2500)},stopLandingCube:()=>{void 0!==o&&(clearInterval(o),o=void 0)},landingPanel:t}})(this);var t;this.startLandingCube=e.startLandingCube,this.stopLandingCube=e.stopLandingCube,this.$landingPanel=e.landingPanel,this.$galleryPanel=(e=>{const t=$("#gallery-panel");return $("#gallery-panel-back-button").on("click",(()=>{e.showLandingPanel(),e.$galleryPanel.css("display","none")})),t})(this),(t=this).$startModal.modal({centered:!1}).modal("setting","closable",!1).modal("setting","dimmerSettings",{opacity:0}),$("#start-modal-new-button").on("click",(()=>{t.$newModal.modal("show"),t.$startModal.modal("hide")})),$("#start-modal-load-button").on("click",(()=>{t.$loadModal.modal("show"),t.$startModal.modal("hide")})),$("#start-modal-landing-button").on("click",(()=>{t.$startModal.modal("hide"),t.showLandingPanel()})),(e=>{e.$newModal=$("#new-modal"),e.$newModal.modal({centered:!1}).modal("setting","closable",!1).modal("setting","dimmerSettings",{opacity:0}).modal("setting","onApprove",(()=>!1));const t=$("#new-modal-name-input"),i=$("#new-modal-length-input"),s=$("#new-modal-depth-input"),n=$("#new-modal-height-input"),o=$("#new-modal-error-message"),c=$("#new-modal-kits-input"),a=[];for(const t of e.app.site.availableKitInfos.values())a.push({name:t.name,value:t.id,selected:!0});c.parent().dropdown({values:a});const r=(e,t)=>{const i=e.val().trim();return e.parent().removeClass("error"),0===i.length?(e.parent().addClass("error"),e.parent().parent().parent().addClass("error"),e.trigger("focus"),o.html("Construction "+t+" cannot be empty"),""):i},l=(e,t)=>{const i=e.val().trim();if((e=>/^\d+$/.test(e))(i)){const e=parseInt(i);if(e>=20&&e<=150)return e}return e.parent().addClass("error"),e.parent().parent().parent().addClass("error"),e.trigger("focus"),o.html("Construction "+t+" must be a positive integer between 20 and 150"),-1};$("#new-modal .approve").on("click",(async()=>{t.parent().parent().parent().removeClass("error"),c.parent().parent().parent().removeClass("error");const o=r(t,"name");if(0===o.length)return;if(0===r(i,"length").length)return;const a=l(i,"length");if(a<0)return;if(0===r(s,"depth").length)return;const h=l(s,"depth");if(h<0)return;if(0===r(n,"height").length)return;const p=l(n,"height");if(p<0)return;const d=r(c,"kits");if(0===d.length)return;const u=d.split(",").map((e=>e.trim().replaceAll('"',"")));e.$newModal.modal("hide"),e.$startDimmerContent.show(),await e.app.loadNewSite(o,a,h,p,u),e.$startDimmerContent.hide(),e.$startDimmer.removeClass("active")})),$("#new-modal .cancel").on("click",(async()=>{e.$startModal.modal("show"),e.$newModal.modal("hide")}))})(this),(e=>{e.$loadModal=$("#load-modal"),e.$loadModal.modal({centered:!1}).modal("setting","closable",!1).modal("setting","dimmerSettings",{opacity:0}).modal("setting","onApprove",(()=>!1));const t=$("#load-modal-samples-list"),i=$("#load-modal-samples-list-item-template");let s,n;for(const e of g){const o=i.clone();o.attr("id","samples-list-item-0");const c=o.find("div.header");c.html(e),o.appendTo(t),o.on("click",(()=>{void 0!==n&&(n.css("background-color","transparent"),n.css("color","rgba(0, 0, 0, 0.87)")),s=e,n=c,n.css("background-color","rgb(48, 114, 179)"),n.css("color","rgb(255, 255, 255)")}))}$("#load-modal .approve").on("click",(async()=>{void 0!==s?(e.$loadModal.modal("hide"),e.$startDimmerContent.show(),await e.app.loadSiteFromResource("constructions/samples/"+s+".p3c"),e.$startDimmerContent.hide(),e.$startDimmer.removeClass("active")):e.showErrorMessage("Load construction sample","Please select a sample from the list")})),$("#load-modal .cancel").on("click",(async()=>{e.$startModal.modal("show"),e.$loadModal.modal("hide")}))})(this),(e=>{const t=document.querySelector("#file-selector");t.addEventListener("change",(()=>{const i=t.files[0],s=new FileReader;s.addEventListener("load",(async()=>{e.$startModal.modal("hide"),e.$startDimmerContent.show();const t=s.result;await e.app.loadSiteFromJson(t),e.$startDimmerContent.hide(),e.$startDimmer.removeClass("active")})),s.readAsText(i)})),$("#start-modal-open-button").on("click",(async()=>{t.click()}))})(this),(e=>{this.downloadLink=document.querySelector("#download-link")})(),(e=>{const t=$("#error-message"),i=$("#error-message-title"),s=$("#error-message-content");e.hideErrorMessage=()=>{"true"===t.attr("data-p-open")&&(t.attr("data-p-open","false"),t.transition("fly down"))},$("#error-message .close").on("click",(()=>{e.hideErrorMessage()})),e.showErrorMessage=(n,o)=>{e.hideErrorMessage(),i.html(n),s.html(o),t.attr("data-p-open","true"),t.transition("fly down"),setTimeout((()=>{e.hideErrorMessage()}),5e3)};const n=$("#positive-message"),o=$("#positive-message-title"),c=$("#positive-message-content"),a=()=>{"true"===n.attr("data-p-open")&&(n.attr("data-p-open","false"),n.transition("fly down"))};$("#positive-message .close").on("click",(()=>{a()})),e.showPositiveMessage=(e,t)=>{a(),o.html(e),c.html(t),n.attr("data-p-open","true"),n.transition("fly down"),setTimeout((()=>{a()}),1e4)}})(this),this.$constructionName=v(this);const i=(e=>{const t={};m(t);const i=$("#choose-color-modal-header"),s=$("#choose-color-modal");return s.modal({centered:!1}).modal("setting","closable",!1),$("#construction-menu-scene-color").on("click",(()=>{const n=e.app.site.construction.sceneColor;t.setColor({type:"scene",r:n.r,g:n.g,b:n.b}),i.html("Choose the Construction Scene Color"),s.modal("show"),t.updateSaturationLightnessThumb(),t.updateHueSlider()})),$("#construction-menu-base-color").on("click",(()=>{const n=e.app.site.construction.baseColor;t.setColor({type:"base",r:n.r,g:n.g,b:n.b}),i.html("Choose the Construction Base Color"),s.modal("show"),t.updateSaturationLightnessThumb(),t.updateHueSlider()})),$("#choose-color-modal .approve").on("click",(()=>{const i=t.getColor();"scene"===i.type&&(e.app.site.construction.sceneColor.setRGB(i.r,i.g,i.b),e.$constructionMenuSceneColorIcon.css("background-color","#"+e.app.site.construction.sceneColor.getHexString()),e.app.site.renderConstruction(),e.app.site.renderPiece(),e.createChooseKitPieceImages()),"base"===i.type&&(e.app.site.construction.baseColor.setRGB(i.r,i.g,i.b),e.app.site.scene.children[e.app.site.baseSceneIndex].material.color=e.app.site.construction.baseColor,e.$constructionMenuBaseColorIcon.css("background-color","#"+e.app.site.construction.baseColor.getHexString()),e.app.site.renderConstruction(),e.app.site.renderPieceBase())})),{constructionMenuSceneColorIcon:$("#construction-menu-scene-color-icon"),constructionMenuBaseColorIcon:$("#construction-menu-base-color-icon")}})(this);this.$constructionMenuSceneColorIcon=i.constructionMenuSceneColorIcon,this.$constructionMenuBaseColorIcon=i.constructionMenuBaseColorIcon,b(this),this.$kitName=(e=>{const t=$("#choose-kit-modal-kits-input"),i=$("#kits-modal-error-message"),s=$("#choose-kit-modal");return s.modal({centered:!1}).modal("setting","closable",!1).modal("setting","autofocus",!1).modal("setting","onApprove",(()=>!1)),$("#kit-choose-button").on("click",(()=>{t.parent().removeClass("error"),t.parent().parent().parent().removeClass("error");const i=[];for(const t of e.app.site.availableKitInfos.values()){const s=t.id;i.push({name:t.name,value:s,selected:e.app.site.construction.kits.includes(s)})}t.parent().dropdown({values:i}),s.modal("show")})),$("#choose-kit-modal .approve").on("click",(async()=>{t.parent().removeClass("error"),t.parent().parent().parent().removeClass("error");const n=e.app.site.construction,o=t.val().trim();if(t.parent().removeClass("error"),0===o.length)return t.parent().addClass("error"),t.parent().parent().parent().addClass("error"),t.trigger("focus"),void i.html(" The list of kits used by the construction cannot be empty");const c=o.split(",").map((e=>e.trim().replaceAll('"',""))),a=e.app.site.construction.findPiecesPerKit();for(const s of n.kits)if(!c.includes(s)&&0!==a.get(s))return t.parent().addClass("error"),t.parent().parent().parent().addClass("error"),t.trigger("focus"),void i.html('The construction is using pieces from the kit "<strong>'+e.app.site.availableKitInfos.get(s).name+'</strong>"; this kit cannot be removed from the list of kits used by the construction');n.kits=c,await e.app.site.loadKits(),e.app.site.currentKit=n.kits[0],e.$kitName.html(e.app.site.loadedKits.get(e.app.site.currentKit).kitInfo.name),e.app.site.currentPieceIndexInKit=0,e.app.site.currentPieceRotation=1,e.app.site.currentPiecePoint=1,e.app.site.kitPieceImageUrls.clear(),e.createChooseKitPieceItems(),e.createChooseKitPieceImages(),e.app.site.createCurrentPiece(),e.app.site.createCurrentPieceBase(),e.app.site.renderPiece(),e.app.site.renderPieceBase(),s.modal("hide")})),$("#kit-name")})(this);const s=(e=>{const t=e=>e.consMoveX+", "+e.consMoveY+" • "+e.consAngle+"° 👁 "+e.eyeRadius+" • "+(90-e.eyeAngle)+"°",i=$("#view-name"),s=$("#choose-view-modal");s.modal({centered:!1}).modal("setting","closable",!1).modal("setting","onDeny",(e=>e.hasClass("cancel")));const n=$("#choose-view-list"),o=$("#choose-view-list-item-template");let c,a=-1;const r=()=>{(async()=>{e.app.site.viewImageCanvas.width=e.app.site.viewImageWidth,e.app.site.viewImageRenderer.setSize(e.app.site.viewImageWidth,160,!1);const t=e.app.site.scene.clone();for(let i=0;i<e.app.site.construction.views.length;i++){const s=await e.app.site.renderViewImage(t,i);$("#choose-view-img-"+i).attr("src",s)}t.dispose()})()},l=()=>{void 0!==c&&c.removeClass().addClass("ui segment")};return $("#choose-view-modal .delete").on("click",(()=>{-1!==a?0!==a?(e.app.site.construction.views.splice(a,1),e.createChooseViewItems(),r()):e.showErrorMessage("Delete view","The default (first) view should not be deleted, please select another view"):e.showErrorMessage("Delete view","Please select a view first")})),$("#choose-view-modal .approve").on("click",(()=>{l(),a>-1&&(e.app.site.currentView=e.app.site.construction.views[a].cloneView(),e.updateViewNameLabel(),e.app.site.renderConstruction(),e.app.site.renderPiece(),e.app.site.renderPieceBase())})),$("#choose-view-modal .cancel").on("click",(()=>{l()})),$("#view-choose-button").on("click",(()=>{a=-1,c=void 0;for(let t=0;t<e.app.site.construction.views.length;t++){const i=$("#choose-view-loader-"+t);i.css("background-color","#"+e.app.site.construction.sceneColor.getHexString()),i.width(e.app.site.viewImageWidth),$("#choose-view-img-"+t).attr("src","assets/svg/load-spinner.svg")}s.modal("show"),r()})),$("#add-view-button").on("click",(()=>{e.app.site.construction.views.push(e.app.site.currentView.cloneView()),e.createChooseViewItems(),e.showPositiveMessage("Add view",'The current view <span class="ui header">'+t(e.app.site.currentView)+"</span> was added to the list of views")})),{createChooseViewItems:()=>{a=-1,c=void 0,n.empty();for(let i=0;i<e.app.site.construction.views.length;i++){const s=o.clone();s.attr("id","choose-view-list-item-"+i),s.appendTo(n);const r=s.children("#choose-view-loader-template");r.attr("id","choose-view-loader-"+i),r.css("background-color","#"+e.app.site.construction.sceneColor.getHexString()),r.width(e.app.site.viewImageWidth);const h=r.children("#choose-view-img-template");h.attr("id","choose-view-img-"+i),h.attr("src","assets/svg/load-spinner.svg");const p=s.children("#choose-view-name-template");p.attr("id","choose-view-name-"+i),p.html(t(e.app.site.construction.views[i]));const d=i,u=()=>{var e,t;e=s,t=d,l(),a=t,c=e,c.removeClass().addClass("ui segment p-blue-button-background")};s.on("click",u),h.on("click",u),p.on("click",u)}},updateViewNameLabel:()=>{i.html(t(e.app.site.currentView))}}})(this);this.createChooseViewItems=s.createChooseViewItems,this.updateViewNameLabel=s.updateViewNameLabel;const n=(e=>{const t=$("#choose-piece-modal");t.modal({centered:!1}).modal("setting","closable",!1);const i=$("#choose-piece-kits-menu"),s=$("#choose-piece-kits-tabs");let n,o,c,a,r,l,h,p;const d=()=>{void 0!==h&&(clearInterval(h),c.removeClass().addClass("ui segment"),a.attr("src",e.app.site.kitPieceImageUrls.get(r)[l]),h=void 0)},u=(t,i,s,n)=>{d(),r=s,l=n,c=t,a=i,c.removeClass().addClass("ui segment p-blue-button-background"),a.attr("src",e.app.site.kitPieceImageUrls.get(r)[l]),p=0,h=setInterval((async()=>{const t=a,i=await e.app.site.renderPieceImage(r,l,k+p*f);t===a&&a.attr("src",i),p++,32===p&&(p=0)}),250)},m=$("#choose-piece-kits-menu-item-template"),g=$("#choose-piece-kits-tab-template"),w=$("#choose-piece-list-template"),v=$("#choose-piece-list-item-template");$("#choose-piece-modal .approve").on("click",(()=>{d(),e.app.site.currentKit=r,e.$kitName.html(e.app.site.loadedKits.get(e.app.site.currentKit).kitInfo.name),e.app.site.currentPieceIndexInKit=l,e.app.site.currentPiecePoint=1,e.app.site.createCurrentPiece(),e.app.site.createCurrentPieceBase(),e.app.site.renderPiece(),e.app.site.renderPieceBase()})),$("#choose-piece-modal .cancel").on("click",(()=>{d()})),$("#piece-choose-button").on("click",(()=>{r=e.app.site.currentKit,l=e.app.site.currentPieceIndexInKit,n.removeClass("active"),o.hide(),n=$("#choose-piece-kits-menu-item-"+r),o=$("#choose-piece-kits-tab-"+r),n.removeClass().addClass("active item"),o.show(),u($("#choose-piece-list-item-"+r+"-"+l),$("#choose-piece-img-"+r+"-"+l),r,l),t.modal("show")}));const b=(t,i)=>{e.app.site.currentPieceRotation+=t,0===e.app.site.currentPieceRotation&&(e.app.site.currentPieceRotation=4),5===e.app.site.currentPieceRotation&&(e.app.site.currentPieceRotation=1),e.app.site.createCurrentPiece(),e.app.site.createCurrentPieceBase(),e.app.site.renderPiece(),e.app.site.renderPieceBase(),i.trigger("blur")},I=$("#rotate-piece-left-button");I.on("click",(()=>{b(1,I)}));const C=$("#rotate-piece-right-button");return C.on("click",(()=>{b(-1,C)})),$("#piece-base-canvas").on("click",(t=>{const i=e.app.site.renderPieceBasePicking(t.offsetX,t.offsetY);0!==i&&i!==e.app.site.currentPiecePoint&&(e.app.site.currentPiecePoint=i,e.app.site.createCurrentPieceBase(),e.app.site.renderPieceBase())})),{createChooseKitPieceItems:()=>{i.empty(),s.empty();for(const t of e.app.site.construction.kits){const h=e.app.site.loadedKits.get(t),p=m.clone();p.attr("id","choose-piece-kits-menu-item-"+t),p.attr("data-kit-id",t),p.text(h.kitInfo.name),p.appendTo(i);const d=g.clone();d.attr("id","choose-piece-kits-tab-"+t),d.appendTo(s),p.on("click",(()=>{p!==n&&(n.removeClass("active"),o.hide(),n=p,o=d,n.removeClass().addClass("active item"),o.show())}));const b=w.clone();b.attr("id","choose-piece-list-"+t),b.appendTo(d),t===e.app.site.currentKit&&(n=p,o=d,n.removeClass().addClass("active item"),o.show(),r=t);const k=e.app.site.loadedKits.get(t).kitPieces.length;for(let i=0;i<k;i++){const s=v.clone();s.attr("id","choose-piece-list-item-"+t+"-"+i),s.appendTo(b);const n=s.children("#choose-piece-img-template");n.attr("id","choose-piece-img-"+t+"-"+i);const o=t,h=i,p=()=>{u(s,n,o,h)};s.on("click",p),n.on("click",p),t===e.app.site.currentKit&&i===e.app.site.currentPieceIndexInKit&&(c=s,a=n,r=t,l=i)}}},createChooseKitPieceImages:()=>{(async()=>{for(const t of e.app.site.construction.kits){const i=[],s=e.app.site.loadedKits.get(t).kitPieces.length;for(let n=0;n<s;n++){const s=await e.app.site.renderPieceImage(t,n);i.push(s),$("#choose-piece-img-"+t+"-"+n).attr("src",s)}e.app.site.kitPieceImageUrls.set(t,i)}})()}}})(this);this.createChooseKitPieceItems=n.createChooseKitPieceItems,this.createChooseKitPieceImages=n.createChooseKitPieceImages}}(this)}async loadNewSite(e,t,i,s,n){await this.site.loadNew(e,t,i,s,n),this.appUI.resetUI(),this.site.initialRenders()}async loadSiteFromJson(e){await this.site.loadFromString(e),this.appUI.resetUI(),this.site.initialRenders()}async loadSiteFromResource(e){const t=await $.get(e);await this.loadSiteFromJson(t)}};await r.appUI.loadUI(),"start-modal"===window.name?r.appUI.showStartModal():r.appUI.showLandingPanel()})().catch((e=>console.log(e)));
